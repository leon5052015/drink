<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026 手搖飲記帳</title>
  <style>
    :root {
      --primary: #FF9F43; /* 溫暖的橘色，像珍珠奶茶 */
      --bg: #F4F6F8;
      --card: #FFFFFF;
      --text: #333333;
      --sub-text: #666666;
      --danger: #EE5253;
      --radius: 12px;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 80px; /* 預留底部按鈕空間 */
    }
    
    /* 統計卡片 */
    .stat-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      text-align: center;
      margin-bottom: 20px;
    }
    .stat-total {
      font-size: 3em;
      font-weight: 800;
      color: var(--primary);
      line-height: 1;
    }
    .stat-label {
      color: var(--sub-text);
      font-size: 0.9em;
      margin-top: 5px;
    }
    .stat-row {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }
    .stat-item strong {
      display: block;
      font-size: 1.2em;
    }
    .stat-item span {
      font-size: 0.8em;
      color: var(--sub-text);
    }

    /* 篩選器 */
    .filter-bar {
      display: flex;
      background: #e0e0e0;
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 20px;
    }
    .filter-btn {
      flex: 1;
      text-align: center;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
      color: var(--sub-text);
      transition: 0.2s;
    }
    .filter-btn.active {
      background: #fff;
      color: var(--text);
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* 列表區域 */
    .list-header {
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .record-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .record-item {
      background: var(--card);
      padding: 15px;
      border-radius: var(--radius);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .item-left {
      display: flex;
      flex-direction: column;
    }
    .item-title {
      font-weight: 600;
      font-size: 1.1em;
    }
    .item-sub {
      font-size: 0.85em;
      color: var(--sub-text);
      margin-top: 4px;
    }
    .item-right {
      text-align: right;
      font-weight: bold;
      color: var(--primary);
    }
    .delete-btn {
      color: var(--danger);
      background: none;
      border: none;
      font-size: 0.8em;
      margin-top: 5px;
      cursor: pointer;
      padding: 0;
      text-align: right;
    }

    /* 新增按鈕 (FAB) */
    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(255, 159, 67, 0.4);
      cursor: pointer;
      z-index: 100;
      transition: transform 0.2s;
    }
    .fab:active {
      transform: scale(0.95);
    }

    /* 彈窗 Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .modal-overlay.show {
      display: flex;
      opacity: 1;
    }
    .modal {
      background: var(--card);
      width: 90%;
      max-width: 400px;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      transform: translateY(20px);
      transition: transform 0.3s;
    }
    .modal-overlay.show .modal {
      transform: translateY(0);
    }
    .modal h2 {
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 0.9em;
      color: var(--sub-text);
    }
    .form-control {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      outline: none;
    }
    .form-control:focus {
      border-color: var(--primary);
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }
    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-secondary {
      background: #eee;
      color: #555;
    }

    /* 快選標籤 Chip */
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .chip {
      background: #f0f0f0;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      color: #555;
      cursor: pointer;
    }
    .chip:active {
      background: #e0e0e0;
    }
    
    /* 設定區域 */
    .settings-area {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      text-align: center;
    }
    .btn-small {
      background: #eee;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      color: #666;
      margin: 0 5px;
    }

  </style>
</head>
<body>

<div class="container">
  <div class="stat-card">
    <div class="stat-total" id="totalCups">0</div>
    <div class="stat-label">2026 累積杯數</div>
    <div class="stat-row">
      <div class="stat-item">
        <strong id="totalSpend">$0</strong>
        <span>總花費</span>
      </div>
      <div class="stat-item">
        <strong id="avgPrice">$0</strong>
        <span>平均單價</span>
      </div>
    </div>
  </div>

  <div class="filter-bar">
    <div class="filter-btn active" onclick="setFilter('week')">本週</div>
    <div class="filter-btn" onclick="setFilter('month')">本月</div>
    <div class="filter-btn" onclick="setFilter('all')">全部</div>
  </div>

  <div class="list-header">
    <span>近期紀錄</span>
    <span style="font-size:0.8em; color:#888;" id="recordCount"></span>
  </div>
  <div class="record-list" id="recordList">
    </div>
  
  <div class="settings-area">
    <p style="font-size:0.8em; color:#999; margin-bottom:10px;">資料管理</p>
    <button class="btn-small" onclick="exportData()">匯出備份</button>
    <label class="btn-small" style="cursor:pointer">
      匯入備份
      <input type="file" id="importFile" style="display:none" onchange="importData(this)">
    </label>
    <button class="btn-small" style="color:var(--danger)" onclick="clearAllData()">清除所有資料</button>
  </div>
</div>

<div class="fab" onclick="openModal()">+</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2>喝什麼呢？</h2>
    
    <div class="form-group">
      <label>店家</label>
      <input type="text" id="inpStore" class="form-control" placeholder="例如：50嵐">
      <div class="chips" id="storeChips">
        </div>
    </div>

    <div class="form-group">
      <label>品項</label>
      <input type="text" id="inpDrink" class="form-control" placeholder="例如：1號無糖少冰">
      <div class="chips" id="drinkChips">
        </div>
    </div>

    <div class="form-group">
      <label>價格</label>
      <input type="number" id="inpPrice" class="form-control" placeholder="60" inputmode="numeric">
    </div>
    
    <div class="form-group">
      <label>日期</label>
      <input type="date" id="inpDate" class="form-control">
    </div>

    <div class="btn-group">
      <button class="btn btn-secondary" onclick="closeModal()">取消</button>
      <button class="btn btn-primary" onclick="saveRecord()">紀錄！</button>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // 1. 初始化與全域變數
  // ==========================================
  const STORAGE_KEY = 'bubbleTeaRecords';
  let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  let viewRange = 'week'; // 預設看本週 week | month | all

  // 捷徑 helper
  const $ = (s) => document.querySelector(s);
  
  // 安全性：防止 XSS 攻擊的 Helper (將特殊符號轉義)
  const escapeHtml = (unsafe) => String(unsafe)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");

  // 日期處理：轉為本地午夜時間 (解決時區偏移與 'all' 篩選問題)
  const toLocalMidnight = (dateString) => {
    // 建立一個日期物件
    const d = new Date(dateString);
    // 確保回到當地的 00:00:00，避免時區造成跨日誤差
    // 這裡使用字串重組的方式最保險： 'YYYY-MM-DD' + 'T00:00:00'
    return new Date(`${dateString}T00:00:00`);
  };

  // 取得今天日期字串 YYYY-MM-DD
  const getTodayStr = () => {
    const d = new Date();
    // 修正時區偏移，確保取得台灣時間的日期字串
    const offset = d.getTimezoneOffset() * 60000;
    const localISOTime = (new Date(d - offset)).toISOString().slice(0, 10);
    return localISOTime;
  };

  // 啟動時執行
  init();

  function init() {
    renderUI();
    renderChips();
    // 預設日期填入今天
    $('#inpDate').value = getTodayStr();
  }

  // ==========================================
  // 2. 核心邏輯：篩選與統計
  // ==========================================
  function setFilter(range) {
    viewRange = range;
    // 更新按鈕樣式
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.filter-btn')[['week','month','all'].indexOf(range)].classList.add('active');
    renderUI();
  }

  function getFilteredData() {
    const now = new Date();
    // 這裡也使用 toLocalMidnight 確保比較的基準點是乾淨的
    let limitTime = 0; 

    if (viewRange === 'week') {
      // 取得本週一 (本地時間)
      const day = now.getDay() || 7; // 週日是0，改成7
      const d = new Date(now);
      d.setDate(now.getDate() - day + 1);
      const startOfWeekStr = d.toISOString().slice(0, 10);
      limitTime = toLocalMidnight(startOfWeekStr).getTime();
    } 
    else if (viewRange === 'month') {
      // 取得本月1號 (本地時間)
      const startOfMonthStr = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10); // 這裡稍微簡化，取前10碼
       // 更精確的做法：
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      limitTime = toLocalMidnight(`${y}-${m}-01`).getTime();
    }
    // 'all' 的時候 limitTime 維持 0

    return data.filter(d => toLocalMidnight(d.date).getTime() >= limitTime);
  }

  function renderUI() {
    const subData = getFilteredData();
    
    // 排序：日期新的在上面
    // 使用 toLocalMidnight 確保排序不受 UTC 影響
    const sorted = [...subData].sort((a,b) => toLocalMidnight(b.date) - toLocalMidnight(a.date));

    // 1. 更新統計數字
    const totalCount = sorted.length;
    // 價格現在是數字了，直接加總
    const totalSpend = sorted.reduce((sum, d) => sum + d.price, 0); 
    const avg = totalCount > 0 ? Math.round(totalSpend / totalCount) : 0;

    $('#totalCups').innerText = totalCount;
    $('#totalSpend').innerText = '$' + totalSpend;
    $('#avgPrice').innerText = '$' + avg;
    $('#recordCount').innerText = `(${totalCount} 筆)`;

    // 2. 渲染列表
    const listEl = $('#recordList');
    listEl.innerHTML = '';
    
    if (totalCount === 0) {
      listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">這區間還沒喝喔！</div>';
      return;
    }

    sorted.forEach(item => {
      const div = document.createElement('div');
      div.className = 'record-item';
      // 使用 escapeHtml 保護內容
      div.innerHTML = `
        <div class="item-left">
          <div class="item-title">${escapeHtml(item.store)}</div>
          <div class="item-sub">${escapeHtml(item.drink)} · ${item.date}</div>
        </div>
        <div class="item-right">
          <div>$${item.price}</div>
          <button class="delete-btn" onclick="deleteRecord(${item.id})">刪除</button>
        </div>
      `;
      listEl.appendChild(div);
    });
  }

  // ==========================================
  // 3. 資料操作 (CRUD)
  // ==========================================
  function saveRecord() {
    const store = $('#inpStore').value.trim();
    const drink = $('#inpDrink').value.trim();
    // 強制轉為數字，避免存成字串
    const price = Number($('#inpPrice').value);
    const date = $('#inpDate').value;

    // 基本驗證
    if(!store || !drink) {
      alert('請輸入店家和品項');
      return;
    }
    if(!price || price <= 0) {
      alert('請輸入正確的金額');
      return;
    }
    if(!date) {
      alert('請選擇日期');
      return;
    }

    const newRecord = {
      id: Date.now(),
      store,
      drink,
      price, // 這裡存入的保證是 Number
      date
    };

    data.push(newRecord);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    
    closeModal();
    renderUI();
    renderChips(); // 更新常用清單
    
    // 清空輸入框但保留日期
    $('#inpStore').value = '';
    $('#inpDrink').value = '';
    $('#inpPrice').value = '';
  }

  function deleteRecord(id) {
    if(!confirm('確定要刪除這筆紀錄嗎？')) return;
    data = data.filter(d => d.id !== id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    renderUI();
  }

  // ==========================================
  // 4. 介面互動與 UX 優化
  // ==========================================
  function openModal() {
    $('#modal').classList.add('show');
    // 延遲一下讓動畫跑完再 focus
    setTimeout(() => $('#inpStore').focus(), 100);
  }

  function closeModal() {
    $('#modal').classList.remove('show');
  }

  // 點擊背景關閉
  $('#modal').onclick = (e) => {
    if(e.target.id === 'modal') closeModal();
  };

  // 自動產生常用店家/品項 Chips
  function renderChips() {
    // 簡單統計出現最多次的店家
    const storeCounts = {};
    data.forEach(d => { storeCounts[d.store] = (storeCounts[d.store]||0)+1; });
    const topStores = Object.keys(storeCounts).sort((a,b) => storeCounts[b] - storeCounts[a]).slice(0, 5);

    const storeChipsHtml = topStores.map(s => 
      `<div class="chip" onclick="fillStore('${escapeHtml(s)}')">${escapeHtml(s)}</div>`
    ).join('');
    $('#storeChips').innerHTML = storeChipsHtml;
  }

  function fillStore(name) {
    $('#inpStore').value = name;
    
    // UX 優化：點了店家後，自動列出該店喝過的飲料，並將焦點移到品項
    const drankHere = data.filter(d => d.store === name);
    const drinkCounts = {};
    drankHere.forEach(d => { drinkCounts[d.drink] = (drinkCounts[d.drink]||0)+1; });
    const topDrinks = Object.keys(drinkCounts).sort((a,b) => drinkCounts[b] - drinkCounts[a]).slice(0, 5);

    const drinkChipsHtml = topDrinks.map(d => 
      `<div class="chip" onclick="fillDrink('${escapeHtml(d)}')">${escapeHtml(d)}</div>`
    ).join('');
    $('#drinkChips').innerHTML = drinkChipsHtml;

    // 自動聚焦下一欄
    $('#inpDrink').focus();
  }

  function fillDrink(name) {
    $('#inpDrink').value = name;
    
    // UX 優化：嘗試自動填入上次該品項的價格
    const lastRecord = data.find(d => d.store === $('#inpStore').value && d.drink === name);
    if(lastRecord) {
      $('#inpPrice').value = lastRecord.price;
    }
    // 自動聚焦下一欄
    $('#inpPrice').focus();
  }

  // ==========================================
  // 5. 資料匯入匯出
  // ==========================================
  function exportData() {
    const jsonStr = JSON.stringify(data, null, 2); // 美化格式，方便閱讀
    const blob = new Blob([jsonStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bubble_tea_backup_${getTodayStr()}.json`;
    a.click();
  }

  function importData(input) {
    const file = input.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const imported = JSON.parse(e.target.result);
        if(Array.isArray(imported)) {
          if(confirm(`確定要匯入 ${imported.length} 筆資料嗎？(會覆蓋現有資料)`)) {
            // 資料清洗：確保匯入的價格也是數字
            data = imported.map(d => ({
              ...d,
              price: Number(d.price) || 0
            }));
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            renderUI();
            alert('匯入成功！');
          }
        } else {
          alert('格式錯誤：這不是一個紀錄列表');
        }
      } catch(err) {
        alert('檔案讀取失敗，請確認是正確的 JSON 檔');
      }
    };
    reader.readAsText(file);
    // 重置 input 讓同一檔案可重複選
    input.value = ''; 
  }
  
  function clearAllData() {
    if(confirm('警告：這將會刪除所有紀錄且無法復原！確定嗎？')) {
      data = [];
      localStorage.setItem(STORAGE_KEY, JSON.stringify([]));
      renderUI();
    }
  }
</script>

</body>
</html>
